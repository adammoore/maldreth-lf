<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Research Data Lifecycle Visualization</title>
    <style>
        /* Add your CSS styling here */
        .node {
            cursor: pointer;
        }
        .node rect {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 2px;
        }
        .node text {
            font: 12px sans-serif;
        }
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }
        .link.alternative {
            stroke-dasharray: 5, 5;
        }
        .arrow {
            fill: #ccc;
        }
        .title {
            font: 24px sans-serif;
            text-align: center;
            margin-bottom: 20px;
        }
        .explanation {
            font: 14px sans-serif;
            text-align: center;
            margin-bottom: 20px;
        }
        .substage {
            fill: lightblue;
            stroke: blue;
            stroke-width: 1px;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 5px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 1px solid #ccc;
            pointer-events: none;
            border-radius: 5px;
        }
        .exemplar {
            fill: lightgreen;
            stroke: green;
            stroke-width: 1px;
        }
    </style>
</head>
<body>
    <div class="title">Research Data Lifecycle</div>
    <div class="explanation">Click on any stage to explore its substages and exemplars.</div>
    <div id="chart"></div>
    <div id="tooltip" class="tooltip" style="opacity:0;"></div>

    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const width = 960;
            const height = 600;
            const radius = Math.min(width, height) / 2 - 50;
            const rectWidth = 100;
            const rectHeight = 40;

            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);

            const tooltip = d3.select("#tooltip");

            // Define arrow marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '-0 -5 10 10')
                .attr('refX', 13)
                .attr('refY', 0)
                .attr('orient', 'auto')
                .attr('markerWidth', 13)
                .attr('markerHeight', 13)
                .attr('xoverflow', 'visible')
                .append('svg:path')
                .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                .attr('fill', '#ccc')
                .style('stroke', 'none');

            // Fetch the lifecycle data and connections from the API
            Promise.all([
                d3.json('/api/lifecycle'),
                d3.json('/api/connections')
            ]).then(([lifecycleData, connectionsData]) => {
                console.log("Lifecycle data:", lifecycleData);  // Debug information
                console.log("Connections data:", connectionsData);  // Debug information

                const lifecycle = lifecycleData.map((d, i) => ({
                    id: (i + 1).toString(),
                    name: d[0].trim(),
                    description: d[1]
                }));

                const angleScale = d3.scaleLinear()
                    .domain([0, lifecycle.length])
                    .range([0, 2 * Math.PI]);

                lifecycle.forEach((d, i) => {
                    const angle = angleScale(i);
                    d.x = radius * Math.cos(angle - Math.PI / 2);
                    d.y = radius * Math.sin(angle - Math.PI / 2);
                });

                // Create links based on connections data
                svg.selectAll('.link')
                    .data(connectionsData)
                    .enter()
                    .append('line')
                    .attr('class', d => `link ${d[3] === 'alternative' ? 'alternative' : ''}`)
                    .attr('x1', d => lifecycle[d[1] - 1].x)
                    .attr('y1', d => lifecycle[d[1] - 1].y)
                    .attr('x2', d => lifecycle[d[2] - 1].x)
                    .attr('y2', d => lifecycle[d[2] - 1].y)
                    .attr('marker-end', 'url(#arrowhead)');

                // Create nodes
                const node = svg.selectAll('.node')
                    .data(lifecycle)
                    .enter()
                    .append('g')
                    .attr('class', 'node')
                    .attr('transform', d => `translate(${d.x},${d.y})`)
                    .on('click', function(event, d) {
                        d3.json(`/api/substages/${d.name}`).then(substages => {
                            console.log("Substages data:", substages);  // Debug information
                            // Handle substages visualization
                            showSubstages(d, substages);
                        });
                    })
                    .on('mouseover', function(event, d) {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        tooltip.html(`<strong>${d.name}</strong><br>${d.description}`)
                            .style("left", (event.pageX + 5) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on('mouseout', function(d) {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });

                node.append('rect')
                    .attr('x', -rectWidth / 2)
                    .attr('y', -rectHeight / 2)
                    .attr('width', rectWidth)
                    .attr('height', rectHeight);

                node.append('text')
                    .attr('dy', '.35em')
                    .attr('x', 0)
                    .style('text-anchor', 'middle')
                    .text(d => d.name);

                function showSubstages(stage, substages) {
                    // Clear any existing substages
                    svg.selectAll('.substage, .exemplar').remove();

                    // Filter out duplicate substages
                    const uniqueSubstages = Array.from(new Set(substages.map(s => s[0])))
                        .map(name => {
                            return substages.find(s => s[0] === name);
                        });

                    const substageAngleScale = d3.scaleLinear()
                        .domain([0, uniqueSubstages.length])
                        .range([0, Math.PI]);

                    const substageRadius = radius / 2;

                    const substageNodes = svg.selectAll('.substage')
                        .data(uniqueSubstages)
                        .enter()
                        .append('g')
                        .attr('class', 'substage')
                        .attr('transform', (d, i) => {
                            const angle = substageAngleScale(i);
                            const x = stage.x + substageRadius * Math.cos(angle - Math.PI / 2);
                            const y = stage.y + substageRadius * Math.sin(angle - Math.PI / 2);
                            return `translate(${x},${y})`;
                        })
                        .on('click', function(event, d) {
                            showExemplars(d);
                        })
                        .on('mouseover', function(event, d) {
                            tooltip.transition()
                                .duration(200)
                                .style("opacity", .9);
                            tooltip.html(`<strong>${d[0]}</strong><br>${d[1]}`)
                                .style("left", (event.pageX + 5) + "px")
                                .style("top", (event.pageY - 28) + "px");
                        })
                        .on('mouseout', function(d) {
                            tooltip.transition()
                                .duration(500)
                                .style("opacity", 0);
                        });

                    substageNodes.append('rect')
                        .attr('x', -rectWidth / 4)
                        .attr('y', -rectHeight / 4)
                        .attr('width', rectWidth / 2)
                        .attr('height', rectHeight / 2);

                    substageNodes.append('text')
                        .attr('dy', '.35em')
                        .attr('x', 0)
                        .style('text-anchor', 'middle')
                        .text(d => d[0]);
                }

                function showExemplars(substage) {
                    // Clear any existing exemplars
                    svg.selectAll('.exemplar').remove();

                    const exemplars = lifecycleData
                        .filter(d => d[0].trim() === substage[0])
                        .map(d => ({
                            name: d[2].trim(),
                            description: d[1],
                            link: d[3],
                            provider: d[4]
                        }));

                    const exemplarNodes = svg.selectAll('.exemplar')
                        .data(exemplars)
                        .enter()
                        .append('g')
                        .attr('class', 'exemplar')
                        .attr('transform', (d, i) => {
                            const angle = Math.PI + i * (Math.PI / exemplars.length);
                            const x = substage.x + substageRadius * Math.cos(angle - Math.PI / 2);
                            const y = sub.y + substageRadius * Math.sin(angle - Math.PI / 2);
                            return `translate(${x},${y})`;
                        })
                        .on('mouseover', function(event, d) {
                            tooltip.transition()
                                .duration(200)
                                .style("opacity", .9);
                            tooltip.html(`<strong>${d.name}</strong><br>${d.description}<br><a href="${d.link}" target="_blank">${d.link}</a>`)
                                .style("left", (event.pageX + 5) + "px")
                                .style("top", (event.pageY - 28) + "px");
                        })
                        .on('mouseout', function(d) {
                            tooltip.transition()
                                .duration(500)
                                .style("opacity", 0);
                        });

                    exemplarNodes.append('rect')
                        .attr('x', -rectWidth / 4)
                        .attr('y', -rectHeight / 4)
                        .attr('width', rectWidth / 2)
                        .attr('height', rectHeight / 2);

                    exemplarNodes.append('text')
                        .attr('dy', '.35em')
                        .attr('x', 0)
                        .style('text-anchor', 'middle')
                        .text(d => d.name);
                }
            }).catch(error => {
                console.error('Error fetching lifecycle data:', error);
            });
        });
    </script>
</body>
</html>
